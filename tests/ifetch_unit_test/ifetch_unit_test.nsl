#include "ifetch_unit.h"
#include "wishbone_syscon.h"
#include "ram64x8K.h"

declare ifetch_unit_test simulation {
	input newpc[32];
	func_in redirect(newpc);
	output fetch_packet[SIZEOF_FETCH_PACKET_T];
	func_out push2(fetch_packet);
}

module ifetch_unit_test {
	ifetch_unit ifu;
	wishbone_syscon wb_syscon;
	ram64x8K ram;
	reg r = 0;
	fetch_packet_t reg packet;
	func_self pop();

	wb_syscon.CLK_I = m_clock;
	wb_syscon.RST_I = p_reset;

	if(~r) {
		r := ~r;
		ifu.reset();
		ram.reset();
	}
	func redirect {
		ifu.redirect(newpc);
	}
	if(!ifu.ibuf_empty && !redirect) {
		ifu.ibuf_pop();
		pop();
	}
	func pop seq {
		packet := ifu.ibuf_fetch_packet;
		if(!redirect) {
			push2(packet);
		}
	}
	WISHBONE_P2P(ifu, ram, wb_syscon);
}
